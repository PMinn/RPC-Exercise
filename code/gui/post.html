<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="/eel.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/underline@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/editorjs-drag-drop"></script>

    <script src="./editorjs/i18n.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./bootstrap/bootstrap.css">

    <link rel="stylesheet" href="./css/post.css">
</head>

<body>
    <div id="main">
        <div id="title"></div>
        <div id="content"></div>
        <div id="time" class="time"></div>
    </div>
    <div id="reply">
        <hr>
    </div>

    <div class="editor-group">
        <div id="editor"></div>
        <div class="create-outer">
            <button type="button" id="create_btn" class="btn btn-primary">送出</button>
        </div>
    </div>
    <script>
        const main = document.getElementById("main");
        const title = document.getElementById("title");
        const replyDOM = document.getElementById("reply");
        const create_btn = document.getElementById("create_btn");
        const time = document.getElementById("time");

        if (location.search.startsWith('?id=')) {
            const id = parseInt(location.search.replace("?id=", ""));
            eel.discussion(id)()
                .then(response => {
                    response = JSON.parse(response.text);
                    console.log(response);
                    time.innerText = new Date(response.time * 1000).toLocaleString();
                    const EDITOR_JS_TOOLS = {
                        embed: Embed,
                        table: Table,
                        marker: Marker,
                        list: List,
                        warning: Warning,
                        code: CodeTool,
                        image: SimpleImage,
                        raw: RawTool,
                        header: Header,
                        checklist: Checklist,
                        delimiter: Delimiter,
                        inlineCode: InlineCode,
                        underline: Underline
                    };

                    var editorTitle = new EditorJS({
                        holder: "title",
                        tools: {
                            header: Header
                        },
                        minHeight: 30,
                        defaultBlock: 'header',
                        placeholder: '標題',
                        readOnly: true,
                        data: { "blocks": response.topic }
                    });


                    var editorBody = new EditorJS({
                        holder: "content",
                        tools: EDITOR_JS_TOOLS,
                        readOnly: true,
                        data: { "blocks": response.content }
                    });

                    response.reply.forEach(reply => {
                        console.log(reply)

                        var outer = document.createElement("div");
                        var name = document.createElement("div");
                        var time = document.createElement("div");
                        time.classList.add("time");
                        time.innerText = new Date(reply.time * 1000).toLocaleString();
                        var hr = document.createElement("hr");
                        name.classList.add("username");
                        name.innerText = reply.owneUsername + ':';
                        var inner = document.createElement("div");
                        inner.id = `reply_${reply.id}`;
                        outer.appendChild(name);
                        outer.appendChild(inner);
                        outer.appendChild(time);
                        replyDOM.appendChild(outer);
                        replyDOM.appendChild(hr);
                        new EditorJS({
                            holder: `reply_${reply.id}`,
                            tools: EDITOR_JS_TOOLS,
                            readOnly: true,
                            data: { "blocks": reply.content }
                        });
                        if (window.parent.loginedUsername == reply.owneUsername) {
                            var delete_btn = create_delete({
                                type: 'reply',
                                postId: response.id,
                                replyId: reply.id
                            });
                            outer.appendChild(delete_btn);
                        }
                    });

                    if (window.parent.isLogin) {
                        document.querySelector(".editor-group ").style.display = "block";
                        var editorEditor = new EditorJS({
                            holder: "editor",
                            tools: EDITOR_JS_TOOLS,
                            i18n: i18n,
                            placeholder: '新增回覆內容',
                            onReady: () => {
                                new DragDrop(editorEditor);
                            }
                        });
                        if (window.parent.loginedUsername == response.owneUsername) {
                            var delete_btn = create_delete({
                                type: 'post',
                                postId: response.id
                            });
                            main.appendChild(delete_btn);
                        }
                    }


                    create_btn.addEventListener('click', () => {
                        editorEditor.save()
                            .then(savedata => {
                                eel.reply(id, savedata.blocks)()
                                    .then(response => {
                                        window.parent.reload();
                                    });
                            })
                    })
                })

            function create_delete(option) {
                var outer = document.createElement('div');
                outer.classList.add("align-right");
                outer.innerHTML = `<svg class="delete-btn" onclick="delete_postOrReply('${JSON.stringify(option).replaceAll('"', '\\\'')}')" width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.1 3C11.1 2.17157 11.7716 1.5 12.6 1.5H23.4C24.2284 1.5 24.9 2.17157 24.9 3C24.9 3.82843 24.2284 4.5 23.4 4.5H12.6C11.7716 4.5 11.1 3.82843 11.1 3ZM1.5 8.4C1.5 7.57157 2.17157 6.9 3 6.9H33C33.8284 6.9 34.5 7.57157 34.5 8.4C34.5 9.22843 33.8284 9.9 33 9.9H30.9V27.6C30.9 31.4284 27.8284 34.5 24 34.5H12C8.14476 34.5 5.09999 31.4014 5.09999 27.45V9.9H3C2.17157 9.9 1.5 9.22843 1.5 8.4ZM8.09999 9.9V27.45C8.09999 29.7986 9.85523 31.5 12 31.5H24C26.1716 31.5 27.9 29.7716 27.9 27.6V9.9H8.09999ZM13.95 13.8C14.7784 13.8 15.45 14.4716 15.45 15.3V26.25C15.45 27.0784 14.7784 27.75 13.95 27.75C13.1216 27.75 12.45 27.0784 12.45 26.25V15.3C12.45 14.4716 13.1216 13.8 13.95 13.8ZM22.05 13.8C22.8784 13.8 23.55 14.4716 23.55 15.3V26.25C23.55 27.0784 22.8784 27.75 22.05 27.75C21.2216 27.75 20.55 27.0784 20.55 26.25V15.3C20.55 14.4716 21.2216 13.8 22.05 13.8Z" fill="black"/></svg>`;
                return outer;
            }
        }

        function delete_postOrReply(option) {
            option = option.replaceAll("'", "\"")
            eel.delete(JSON.parse(option))()
                .then(response => {
                    window.parent.reload();
                });
        }

    </script>
</body>

</html>