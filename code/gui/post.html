<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="/eel.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/embed@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/table@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/underline@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@latest"></script>

    <script src="https://cdn.jsdelivr.net/npm/editorjs-drag-drop"></script>

    <script src="./editorjs/i18n.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="./bootstrap/bootstrap.css">

    <style>
        #title .ce-toolbar {
            display: none !important;
        }

        .ce-paragraph {
            cursor: text;
        }

        .main,
        #reply>div {
            padding: 30px;
        }

        .editor-group {
            border: 1px hsl(210, 14%, 20%) solid;
            width: calc(100% - 60px);
            margin: 0 auto;
            padding: 20px;
            border-radius: 0.375rem;
            display: none;
        }

        #editor .codex-editor__redactor,
        .main .codex-editor__redactor,
        #reply .codex-editor__redactor {
            padding-bottom: 5px !important;
        }

        .create-outer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        #reply {
            background-color: #0b59ad18;
        }

        .username {
            font-weight: 900;
        }

        #reply hr {
            margin-top: 0;
        }

        hr {
            margin-bottom: 0;
        }
    </style>
    </style>
</head>

<body>
    <div class="main">
        <div id="title"></div>
        <div id="content"></div>
    </div>
    <hr>
    <div id="reply"></div>

    <div class="editor-group">
        <div id="editor"></div>
        <div class="create-outer">
            <button type="button" id="create_btn" class="btn btn-primary">送出</button>
        </div>
    </div>
    <script>
        const title = document.getElementById("title");
        const replyDOM = document.getElementById("reply");
        const create_btn = document.getElementById("create_btn");

        if (location.search.startsWith('?id=')) {
            const id = parseInt(location.search.replace("?id=", ""));

            console.log(`now page id is ${id}`);

            eel.discussion(id)()
                .then(response => {
                    response = JSON.parse(response.text);
                    console.log(response);

                    const EDITOR_JS_TOOLS = {
                        embed: Embed,
                        table: Table,
                        marker: Marker,
                        list: List,
                        warning: Warning,
                        code: CodeTool,
                        image: SimpleImage,
                        raw: RawTool,
                        header: Header,
                        checklist: Checklist,
                        delimiter: Delimiter,
                        inlineCode: InlineCode,
                        underline: Underline
                    };

                    var editorTitle = new EditorJS({
                        holder: "title",
                        tools: {
                            header: Header
                        },
                        minHeight: 30,
                        defaultBlock: 'header',
                        placeholder: '標題',
                        readOnly: true,
                        data: { "blocks": response.topic }
                    });


                    var editorBody = new EditorJS({
                        holder: "content",
                        tools: EDITOR_JS_TOOLS,
                        readOnly: true,
                        data: { "blocks": response.content }
                    });

                    response.reply.forEach(reply => {
                        console.log(reply)

                        var outer = document.createElement("div");
                        var name = document.createElement("div");
                        var hr = document.createElement("hr");
                        name.classList.add("username");
                        name.innerText = reply.owneUsername + ':';
                        var inner = document.createElement("div");
                        inner.id = `reply_${reply.id}`;
                        outer.appendChild(name);
                        outer.appendChild(inner);
                        outer.appendChild(hr);
                        replyDOM.appendChild(outer);
                        new EditorJS({
                            holder: `reply_${reply.id}`,
                            tools: EDITOR_JS_TOOLS,
                            readOnly: true,
                            data: { "blocks": reply.content }
                        });
                    });


                    if (window.parent.isLogin) {
                        document.querySelector(".editor-group ").style.display = "block";
                        var editorEditor = new EditorJS({
                            holder: "editor",
                            tools: EDITOR_JS_TOOLS,
                            i18n: i18n,
                            placeholder: '新增回覆內容',
                            onReady: () => {
                                new DragDrop(editorEditor);
                            }
                        });
                    }
                    create_btn.addEventListener('click', () => {
                        editorEditor.save()
                            .then(savedata => {
                                eel.reply(id, savedata.blocks);
                            })
                    })
                })
        }
    </script>
</body>

</html>